name: Deploy Web Server to EC2 (Native SSH)

on:
  push:
    branches:
      - main

jobs:
  # TRABAJO 1: Instalar Docker (Usando SSH nativo)
  setup-environment:
    name: Setup Docker on EC2
    runs-on: ubuntu-latest
    steps:
      - name: Install Docker via SSH
        env:
          # AQUI ESTABAN LOS ERRORES DE NOMBRE, LOS HE CORREGIDO:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # --- VALIDACI√ìN DE SECRETOS ---
          if [ -z "$HOST" ]; then
            echo "‚ùå Error Cr√≠tico: El secreto 'EC2_HOST' est√° vac√≠o o no existe."
            exit 1
          fi
          if [ -z "$USER" ]; then
            echo "‚ùå Error Cr√≠tico: El secreto 'EC2_USER' est√° vac√≠o o no existe."
            exit 1
          fi
          if [ -z "$PRIVATE_KEY" ]; then
            echo "‚ùå Error Cr√≠tico: El secreto 'EC2_SSH_KEY' est√° vac√≠o o no existe."
            exit 1
          fi
          # ------------------------------

          echo "üîç DIAGN√ìSTICO: Intentando conectar a $HOST como usuario '$USER'..."

          # 1. Crear el archivo de la clave privada
          # TRUCO: Usamos 'tr' para borrar caracteres extra√±os de Windows (\r) que suelen romper las llaves
          echo "$PRIVATE_KEY" | tr -d '\r' > key.pem
          chmod 600 key.pem
          
          # --- NUEVO: DIAGN√ìSTICO DE LA LLAVE ---
          echo "üîç DIAGN√ìSTICO DE LLAVE:"
          # Esto intentar√° leer la llave y mostrar su huella digital. Si falla aqu√≠, la llave est√° mal copiada.
          if ssh-keygen -l -f key.pem; then
             echo "‚úÖ La llave tiene formato v√°lido."
          else
             echo "‚ùå LA LLAVE NO ES V√ÅLIDA. Revisa que hayas copiado TODO el contenido, incluyendo BEGIN y END."
             exit 1
          fi
          # -------------------------------------
          
          # 2. Conectar por SSH y ejecutar comandos (A√±adido -v para ver detalles del error)
          ssh -v -o StrictHostKeyChecking=no -i key.pem "$USER@$HOST" << 'EOF'
            # Verificamos si es Amazon Linux para usar los comandos correctos
            if [ -f /etc/system-release ] && grep -q "Amazon Linux" /etc/system-release; then
                echo "‚úÖ Detectado Amazon Linux."
            fi

            if ! command -v docker &> /dev/null; then
                echo "Docker no encontrado. Instalando en Amazon Linux..."
                sudo yum update -y
                sudo yum install -y docker
                sudo service docker start
                sudo systemctl enable docker
                sudo usermod -aG docker ec2-user
                echo "Docker instalado."
            else
                echo "Docker ya est√° instalado."
                sudo service docker start || true
            fi
          EOF
          
          # 3. Borrar la clave por seguridad
          rm key.pem

  # TRABAJO 2: Copiar archivos y Desplegar (Usando SCP y SSH nativos)
  deploy-app:
    name: Build and Run Container
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          # CORRECCI√ìN DE NOMBRES TAMBI√âN AQU√ç:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # --- VALIDACI√ìN ---
          if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$PRIVATE_KEY" ]; then
             echo "‚ùå Error: Faltan secretos en GitHub."
             exit 1
          fi

          echo "üîç DIAGN√ìSTICO: Desplegando en $HOST con usuario '$USER'..."

          # 1. Preparar la clave (Limpiando caracteres de Windows)
          echo "$PRIVATE_KEY" | tr -d '\r' > key.pem
          chmod 600 key.pem
          
          # 2. Crear carpeta destino
          ssh -v -o StrictHostKeyChecking=no -i key.pem "$USER@$HOST" "mkdir -p /home/$USER/app"
          
          # 3. Copiar archivos con SCP
          scp -o StrictHostKeyChecking=no -i key.pem Dockerfile index.html "$USER@$HOST:/home/$USER/app/"
          
          # 4. Construir y correr Docker remotamente
          ssh -v -o StrictHostKeyChecking=no -i key.pem "$USER@$HOST" << 'EOF'
            # Aseguramos la ruta correcta para ec2-user
            cd /home/ec2-user/app
            
            echo "Construyendo imagen..."
            sudo docker build -t mi-web-server .
            
            echo "Reiniciando contenedor..."
            sudo docker stop web-container || true
            sudo docker rm web-container || true
            sudo docker run -d -p 80:80 --name web-container mi-web-server
          EOF
          
          rm key.pem

  # TRABAJO 3: Test de Verificaci√≥n
  verify-deployment:
    name: HTTP Health Check
    runs-on: ubuntu-latest
    needs: deploy-app
    steps:
      - name: Check HTTP Status
        run: |
          sleep 5
          echo "Testeando conexi√≥n a http://${{ secrets.EC2_HOST }}..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}\n" http://${{ secrets.EC2_HOST }})
          
          if [ "$status_code" -eq 200 ]; then
            echo "‚úÖ √âXITO: El servidor responde."
          else
            echo "‚ùå ERROR: C√≥digo $status_code"
            exit 1
          fi