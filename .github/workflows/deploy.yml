name: Deploy Web Server to EC2 (Native SSH)

on:
  push:
    branches:
      - main

jobs:
  # TRABAJO 1: Instalar Docker (Usando SSH nativo)
  setup-environment:
    name: Setup Docker on EC2
    runs-on: ubuntu-latest
    steps:
      - name: Install Docker via SSH
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # --- LIMPIEZA Y VALIDACI√ìN ---
          CLEAN_HOST=$(echo "$HOST" | xargs)
          CLEAN_USER=$(echo "$USER" | xargs)

          # 1. Validar que tenemos IP y Usuario
          if [ -z "$CLEAN_HOST" ] || [ -z "$CLEAN_USER" ]; then
            echo "‚ùå Error Cr√≠tico: Faltan secretos de HOST o USER."
            exit 1
          fi

          # 2. VALIDACI√ìN DE TIPO DE LLAVE
          if [[ "$PRIVATE_KEY" != *"-----BEGIN"* ]]; then
             echo "‚ùå ERROR FATAL: El secreto EC2_SSH_KEY no parece una llave privada."
             exit 1
          fi

          echo "üîç Conectando a $CLEAN_HOST con usuario '$CLEAN_USER'..."

          # 3. Preparar la llave
          printf "%s\n" "$PRIVATE_KEY" | tr -d '\r' > key.pem
          chmod 600 key.pem
          
          # --- DETECTOR DE HUELLAS (MEJORADO) ---
          echo "üîç DIAGN√ìSTICO DE LLAVE (COMPARAR CON AWS):"
          echo "   La llave cargada en GitHub tiene estas huellas:"
          echo "   - MD5:  $(ssh-keygen -l -E md5 -f key.pem | awk '{print $2}')"
          echo "   - SHA1: $(ssh-keygen -l -E sha1 -f key.pem | awk '{print $2}')"
          echo "   üëâ En tu captura, la llave 'NeedsFinal' empieza por 'e0:f7:70...' (SHA1)."
          echo "      Si la l√≠nea SHA1 de arriba no coincide, est√°s usando el archivo .pem incorrecto."
          # -----------------------------------
          
          # 4. Conectar por SSH
          ssh -v -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -i key.pem "$CLEAN_USER@$CLEAN_HOST" << 'EOF'
            echo "‚úÖ ¬°Conexi√≥n establecida con √©xito!"
            
            # Verificamos sistema
            if [ -f /etc/system-release ]; then
                cat /etc/system-release
            fi

            if ! command -v docker &> /dev/null; then
                echo "Docker no encontrado. Instalando en Amazon Linux..."
                sudo yum update -y
                sudo yum install -y docker
                sudo service docker start
                sudo systemctl enable docker
                sudo usermod -aG docker ec2-user
                echo "Docker instalado."
            else
                echo "Docker ya est√° instalado."
                sudo service docker start || true
            fi
          EOF
          
          rm key.pem

  # TRABAJO 2: Copiar archivos y Desplegar
  deploy-app:
    name: Build and Run Container
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          CLEAN_HOST=$(echo "$HOST" | xargs)
          CLEAN_USER=$(echo "$USER" | xargs)
          
          printf "%s\n" "$PRIVATE_KEY" | tr -d '\r' > key.pem
          chmod 600 key.pem
          
          # Crear carpeta
          ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -i key.pem "$CLEAN_USER@$CLEAN_HOST" "mkdir -p ~/app"
          
          # Copiar archivos
          scp -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -i key.pem Dockerfile index.html "$CLEAN_USER@$CLEAN_HOST:~/app/"
          
          # Desplegar
          ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -i key.pem "$CLEAN_USER@$CLEAN_HOST" << 'EOF'
            cd ~/app
            echo "Construyendo imagen..."
            sudo docker build -t mi-web-server .
            
            echo "Reiniciando contenedor..."
            sudo docker stop web-container || true
            sudo docker rm web-container || true
            sudo docker run -d -p 80:80 --name web-container mi-web-server
          EOF
          
          rm key.pem

  # TRABAJO 3: Test de Verificaci√≥n
  verify-deployment:
    name: HTTP Health Check
    runs-on: ubuntu-latest
    needs: deploy-app
    steps:
      - name: Check HTTP Status
        env:
            HOST: ${{ secrets.EC2_HOST }}
        run: |
          CLEAN_HOST=$(echo "$HOST" | xargs)
          sleep 5
          echo "Testeando conexi√≥n a http://$CLEAN_HOST..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}\n" http://$CLEAN_HOST)
          
          if [ "$status_code" -eq 200 ]; then
            echo "‚úÖ √âXITO: El servidor responde."
          else
            echo "‚ùå ERROR: C√≥digo $status_code"
            exit 1
          fi