name: Deploy Web Server to EC2 (Appleboy)

on:
  push:
    branches:
      - main

jobs:
  # TRABAJO 1: Preparar el entorno
  setup-environment:
    name: Setup Docker on EC2
    runs-on: ubuntu-latest
    steps:
      - name: Check and Install Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          # USAMOS USUARIO FIJO PARA EVITAR ERRORES DE SECRETOS
          username: ec2-user
          key: ${{ secrets.EC2_KEY_FINAL }}
          port: 22
          debug: true # ACTIVA LOGS DETALLADOS
          # Script para Amazon Linux 2023
          script: |
            if ! command -v docker &> /dev/null; then
                echo "ğŸ“¦ Instalando Docker..."
                sudo yum update -y
                sudo yum install -y docker
                sudo service docker start
                sudo systemctl enable docker
                sudo usermod -aG docker ec2-user
            else
                echo "âœ… Docker ya estÃ¡ instalado."
            fi

  # TRABAJO 2: Copiar archivos y Desplegar (Depende del 1)
  deploy-app:
    name: Build and Run Container
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY_FINAL }}
          source: "Dockerfile,index.html"
          target: "/home/ec2-user/app"

      - name: Build and Run Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY_FINAL }}
          debug: true
          script: |
            cd /home/ec2-user/app
            
            echo "ğŸ³ Construyendo imagen..."
            sudo docker build -t mi-web-server .
            
            echo "ğŸ”„ Reiniciando contenedor..."
            sudo docker stop web-container || true
            sudo docker rm web-container || true
            sudo docker run -d -p 80:80 --name web-container mi-web-server

  # TRABAJO 3: VerificaciÃ³n (Depende del 2)
  verify-deployment:
    name: HTTP Health Check
    runs-on: ubuntu-latest
    needs: deploy-app
    steps:
      - name: Check HTTP Status
        run: |
          echo "â³ Esperando a que el servidor arranque..."
          sleep 10
          
          echo "ğŸ“¡ Testeando http://${{ secrets.EC2_HOST }}..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}\n" http://${{ secrets.EC2_HOST }})
          
          if [ "$status_code" -eq 200 ]; then
            echo "âœ… Â¡Ã‰XITO! El servidor responde correctamente."
          else
            echo "âŒ ERROR: El servidor respondiÃ³ con cÃ³digo $status_code"
            exit 1
          fi